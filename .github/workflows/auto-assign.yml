name: Auto assign

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize

permissions: write-all

jobs:

### ì´ë©”ì¼ì— ì•Œë¦¼ì„ ë³´ëƒ…ë‹ˆë‹¤.
  auto_add:
    name: Auto add reviewer and assignee
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set Reviewers and Assignee
        env:
          GH_TOKEN: ${{ secrets.PR_ASSIGN_KEY }}
        run: |
          AUTHOR="${{ github.event.sender.login }}"
          case "$AUTHOR" in
              immyeong)
                  reviewers=("42kko" "dalcheonroadhead")
                  ;;
              42kko)
                  reviewers=("dalcheonroadhead" "eunSoft")
                  ;;
              dalcheonroadhead)
                  reviewers=("eunSoft" "hxcva1")
                  ;;
              eunSoft)
                  reviewers=("hxcva1" "immyeong")
                  ;;
              hxcva1)
                  reviewers=("immyeong" "42kko")
                  ;;
              *)
                  echo "No reviewers assigned"
                  exit 1
                  ;;
          esac

          # ì‰¼í‘œ(,)ë¡œ ë¦¬ë·°ì–´ ë¬¸ìì—´ ìƒì„±
          reviewers_str=$(IFS=,; echo "${reviewers[*]}")

          echo "Author: $AUTHOR"
          echo "Reviewers: $reviewers_str"

          # PRì— Assignee ì¶”ê°€
          gh pr edit "${{ github.event.pull_request.number }}" --add-assignee "$AUTHOR"

          # ì—¬ëŸ¬ ëª…ì˜ ë¦¬ë·°ì–´ë¥¼ í•œ ë²ˆì— ì¶”ê°€
          gh pr edit "${{ github.event.pull_request.number }}" --add-reviewer "$reviewers_str"

### ë””ìŠ¤ì½”ë“œì— ì•Œë¦¼ì„ ë³´ëƒ…ë‹ˆë‹¤.
  notify_discord:
    name: Send Discord Notification
    runs-on: ubuntu-latest
    needs: auto_add  # auto_add ì™„ë£Œ í›„ ì‹¤í–‰
    steps:
      - name: Send PR Notification to Discord
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_AUTHOR="${{ github.event.sender.login }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          REVIEWERS=$(jq -r '.pull_request.requested_reviewers[].login' <<< '${{ toJson(github.event.pull_request) }}' | paste -sd ", ")

          if [ -z "$REVIEWERS" ]; then
            REVIEWERS="None"
          fi

          curl -H "Content-Type: application/json" \
            -X POST \
            -d "{
              \"embeds\": [
                {
                  \"color\": 16776960,
                  \"title\": \"ğŸ“Œ Pull Request Created/Updated\",
                  \"description\": \"ìƒˆë¡œìš´ PRì´ ìƒì„±ë˜ì—ˆê±°ë‚˜ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.\",
                  \"fields\": [
                    {
                      \"name\": \"PR ì œëª©\",
                      \"value\": \"[$PR_TITLE]($PR_URL)\",
                      \"inline\": false
                    },
                    {
                      \"name\": \"ì‘ì„±ì\",
                      \"value\": \"$PR_AUTHOR\",
                      \"inline\": true
                    },
                    {
                      \"name\": \"ë¦¬ë·°ì–´\",
                      \"value\": \"$REVIEWERS\",
                      \"inline\": true
                    }
                  ],
                  \"timestamp\": \"$(date -u +"%Y-%m-%dT%H:%M:%SZ")\"
                }
              ]
            }" \
            "$DISCORD_URL"
    env:
      GH_TOKEN: ${{ secrets.PR_ASSIGN_KEY }}
      AUTHOR: ${{ github.event.sender.login }}
      OWNER: ${{ github.repository_owner }}
      REPO: ${{ github.event.repository.name }}
      DISCORD_URL: ${{ secrets.DISCORD_WEBHOO_BE }}
